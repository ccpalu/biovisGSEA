<!DOCTYPE html>
<html>

<!-- Authors> Igor Rodrigues Pessoa & Cintia C Palu  -->

<head>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <!--<script type="text/javascript" src="d3.v3.js"></script> -->
    <style type="text/css">
        .link {
            stroke: #ccc;
        }
		.link.selected{
			stroke: red;
		}

        .nodetext {
            pointer-events: none;
            font: 10px sans-serif;
        }

        /* Tooltip container */
        div.tooltip {   
            position: absolute;         
            text-align: center;         
            width: auto;                    
            height: auto;                   
            padding: 2px;               
            font: 12px sans-serif;      
            background: lightsteelblue; 
            border: 0px;        
            border-radius: 8px;         
            pointer-events: none;
			margin-left:30px;
        }
    </style>
</head>

<body>

    <button onclick="linkUnlink()">Link/Unlink</button>
        <button onclick="setPValue()">Filter pValue</button>
        <input type="number" step="any" id="pValue" value="0.1">

    <script type="text/javascript">
        var w = 2700,
            h = 1700

        var pValue = 0.1;
        var linksToRemove = [];
        var linksAux = [];
        var svg = d3.select("body").append("svg:svg")
            .attr("width", w)
            .attr("height", h);

        svg.append("defs").append("marker")
            .attr({
                "id": "arrowhead",
                "viewBox": "-0 -5 10 10",
                "refX": 19,
                "refY": 0,
                "orient": "auto",
                "markerWidth": 13,
                "markerHeight": 13,
                "xoverflow": "visible"
            })
            .append("svg:path")
            .attr("d", "M 0,-5 L 10 ,0 L 0,5")
            .attr("fill", "#999")
            .style("stroke", "none");

        //Loading json file
        /*d3.json("graph.json", function(error, json) {
          if (error) throw error;

          root = json;
          update();
        });*/
       var graph = {"nodes":[{"name":"AGBL1","longname":"ATP/GTP binding protein like 1","pValue":0.0006,"color":"#0000EF","type":"gene","ENSEMBL":"ENSG00000273540","ENTREZID":"123624","logFC":-5.0904,"id":0},{"name":"BAZ2B","longname":"bromodomain adjacent to zinc finger domain 2B","pValue":0.0027,"color":"#00EAFF","type":"gene","ENSEMBL":"ENSG00000226266","ENTREZID":"29994","logFC":-2.5781,"id":1},{"name":"C14orf132","longname":"chromosome 14 open reading frame 132","pValue":0.0326,"color":"#00FFFF","type":"gene","ENSEMBL":"ENSG00000227051","ENTREZID":"56967","logFC":-2.5732,"id":2},{"name":"C22orf24","longname":"chromosome 22 open reading frame 24","pValue":0.0035,"color":"#BFFF40","type":"gene","ENSEMBL":"ENSG00000128254","ENTREZID":"25775","logFC":1.2913,"id":3},{"name":"C3orf35","longname":"chromosome 3 open reading frame 35","pValue":0.0072,"color":"#00BAFF","type":"gene","ENSEMBL":"ENSG00000198590","ENTREZID":"339883","logFC":-3.3347,"id":4},{"name":"C5orf60","longname":"chromosome 5 open reading frame 60","pValue":0.0397,"color":"#00E2FF","type":"gene","ENSEMBL":"ENSG00000204661","ENTREZID":"285679","logFC":-2.8591,"id":5},{"name":"C5orf64","longname":"chromosome 5 open reading frame 64","pValue":0.0001,"color":"#0000BF","type":"gene","ENSEMBL":"ENSG00000178722","ENTREZID":"285668","logFC":-6.5306,"id":6},{"name":"C8orf49","longname":"chromosome 8 open reading frame 49","pValue":0.0019,"color":"#000AFF","type":"gene","ENSEMBL":"ENSG00000255394","ENTREZID":"606553","logFC":-5.1195,"id":7},{"name":"CELF2-AS1","longname":"CELF2 antisense RNA 1","pValue":0.0045,"color":"#0058FF","type":"gene","ENSEMBL":"ENSG00000181800","ENTREZID":"414196","logFC":-4.3013,"id":8},{"name":"DSCR9","longname":"Down syndrome critical region 9 (non-protein coding)","pValue":0.0172,"color":"#009FFF","type":"gene","ENSEMBL":"ENSG00000230366","ENTREZID":"257203","logFC":-3.2734,"id":9},{"name":"DSE","longname":"dermatan sulfate epimerase","pValue":0.0036,"color":"#0035FF","type":"gene","ENSEMBL":"ENSG00000237021","ENTREZID":"29940","logFC":-4.2715,"id":10},{"name":"FAM50B","longname":"family with sequence similarity 50 member B","pValue":0.0248,"color":"#0093FF","type":"gene","ENSEMBL":"ENSG00000238158","ENTREZID":"26240","logFC":-3.6751,"id":11},{"name":"FAM87A","longname":"family with sequence similarity 87 member A","pValue":0.039,"color":"#00D8FF","type":"gene","ENSEMBL":"ENSG00000182366","ENTREZID":"157693","logFC":-3.0427,"id":12},{"name":"GABARAPL3","longname":"GABA type A receptor associated protein like 3 pseudogene","pValue":0.0383,"color":"#00B5FF","type":"gene","ENSEMBL":"ENSG00000279980","ENTREZID":"23766","logFC":-3.0578,"id":13},{"name":"KIF25-AS1","longname":"KIF25 antisense RNA 1","pValue":0.0211,"color":"#00CAFF","type":"gene","ENSEMBL":"ENSG00000229921","ENTREZID":"100505879","logFC":-2.8865,"id":14},{"name":"LINC00052","longname":"long intergenic non-protein coding RNA 52","pValue":0.0047,"color":"#0000EB","type":"gene","ENSEMBL":"ENSG00000259527","ENTREZID":"145978","logFC":-5.5934,"id":15},{"name":"LINC00305","longname":"long intergenic non-protein coding RNA 305","pValue":0.002,"color":"#0058FF","type":"gene","ENSEMBL":"ENSG00000179676","ENTREZID":"221241","logFC":-4.3111,"id":16},{"name":"LINC00477","longname":"long intergenic non-protein coding RNA 477","pValue":0.0026,"color":"#0031FF","type":"gene","ENSEMBL":"ENSG00000197503","ENTREZID":"144360","logFC":-4.7432,"id":17},{"name":"LINC00862","longname":"long intergenic non-protein coding RNA 862","pValue":0.0021,"color":"#0031FF","type":"gene","ENSEMBL":"ENSG00000203721","ENTREZID":"554279","logFC":-4.683,"id":18},{"name":"LINC00998","longname":"long intergenic non-protein coding RNA 998","pValue":0.0001,"color":"#CEFF31","type":"gene","ENSEMBL":"ENSG00000214194","ENTREZID":"401397","logFC":1.6106,"id":19},{"name":"LINC01547","longname":"long intergenic non-protein coding RNA 1547","pValue":0.0381,"color":"#00EBFF","type":"gene","ENSEMBL":"ENSG00000183250","ENTREZID":"84536","logFC":-2.8283,"id":20},{"name":"LINC01558","longname":"long intergenic non-protein coding RNA 1558","pValue":0.0061,"color":"#00AAFF","type":"gene","ENSEMBL":"ENSG00000146521","ENTREZID":"26238","logFC":-3.2218,"id":21},{"name":"LINC01587","longname":"long intergenic non-protein coding RNA 1587","pValue":0.0016,"color":"#0000F4","type":"gene","ENSEMBL":"ENSG00000082929","ENTREZID":"10141","logFC":-5.0326,"id":22},{"name":"LMF1","longname":"lipase maturation factor 1","pValue":0.0002,"color":"#0000BF","type":"gene","ENSEMBL":"ENSG00000260807","ENTREZID":"64788","logFC":-6.0321,"id":23},{"name":"MYCNOS","longname":"MYCN opposite strand","pValue":0.0062,"color":"#E4FF1B","type":"gene","ENSEMBL":"ENSG00000233718","ENTREZID":"10408","logFC":1.9208,"id":24},{"name":"SERHL","longname":"serine hydrolase-like (pseudogene)","pValue":0.0063,"color":"#00BFFF","type":"gene","ENSEMBL":"ENSG00000172250","ENTREZID":"94009","logFC":-2.9755,"id":25},{"name":"SPATA13","longname":"spermatogenesis associated 13","pValue":0.0027,"color":"#0000FF","type":"gene","ENSEMBL":"ENSG00000228741","ENTREZID":"221178","logFC":-4.8233,"id":26},{"name":"TAB2","longname":"TGF-beta activated kinase 1/MAP3K7 binding protein 2","pValue":0.0022,"color":"#0020FF","type":"gene","ENSEMBL":"ENSG00000228408","ENTREZID":"23118","logFC":-4.4579,"id":27},{"name":"TDRG1","longname":"testis development related 1 (non-protein coding)","pValue":0.0114,"color":"#0095FF","type":"gene","ENSEMBL":"ENSG00000204091","ENTREZID":"732253","logFC":-3.3981,"id":28},{"name":"TP53TG1","longname":"TP53 target 1 (non-protein coding)","pValue":0.0104,"color":"#BFFF40","type":"gene","ENSEMBL":"ENSG00000182165","ENTREZID":"11257","logFC":1.1724,"id":29},{"name":"WT1-AS","longname":"WT1 antisense RNA","pValue":0.001,"color":"#0040FF","type":"gene","ENSEMBL":"ENSG00000183242","ENTREZID":"51352","logFC":-4.1902,"id":30},{"name":"ZNF883","longname":"zinc finger protein 883","pValue":0.0103,"color":"#00CAFF","type":"gene","ENSEMBL":"ENSG00000228623","ENTREZID":"169834","logFC":-2.8621,"id":31},{"name":"GO:0006464","longname":"cellular protein modification process","pValue":0.0875,"color":"#FFFFFF","type":"GOBPID","id":32},{"name":"GO:0006950","longname":"response to stress","pValue":0.242,"color":"#FFFFFF","type":"GOBPID","id":33},{"name":"GO:0008150","longname":"biological_process","pValue":1,"color":"#FFFFFF","type":"GOBPID","id":34},{"name":"GO:0008152","longname":"metabolic process","pValue":0.3574,"color":"#FFFFFF","type":"GOBPID","id":35},{"name":"GO:0009987","longname":"cellular process","pValue":0.5398,"color":"#FFFFFF","type":"GOBPID","id":36},{"name":"GO:0019538","longname":"protein metabolic process","pValue":0.242,"color":"#FFFFFF","type":"GOBPID","id":37},{"name":"GO:0033554","longname":"cellular response to stress","pValue":0.0875,"color":"#FFFFFF","type":"GOBPID","id":38},{"name":"GO:0036211","longname":"protein modification process","pValue":0.0875,"color":"#FFFFFF","type":"GOBPID","id":39},{"name":"GO:0043170","longname":"macromolecule metabolic process","pValue":0.1472,"color":"#FFFFFF","type":"GOBPID","id":40},{"name":"GO:0043412","longname":"macromolecule modification","pValue":0.0875,"color":"#FFFFFF","type":"GOBPID","id":41},{"name":"GO:0044237","longname":"cellular metabolic process","pValue":0.1485,"color":"#FFFFFF","type":"GOBPID","id":42},{"name":"GO:0044238","longname":"primary metabolic process","pValue":0.2543,"color":"#FFFFFF","type":"GOBPID","id":43},{"name":"GO:0044260","longname":"cellular macromolecule metabolic process","pValue":0.0716,"color":"#FFFFFF","type":"GOBPID","id":44},{"name":"GO:0044267","longname":"cellular protein metabolic process","pValue":0.0875,"color":"#FFFFFF","type":"GOBPID","id":45},{"name":"GO:0050896","longname":"response to stimulus","pValue":0.7908,"color":"#FFFFFF","type":"GOBPID","id":46},{"name":"GO:0051716","longname":"cellular response to stimulus","pValue":0.6848,"color":"#FFFFFF","type":"GOBPID","id":47},{"name":"GO:0071704","longname":"organic substance metabolic process","pValue":0.2505,"color":"#FFFFFF","type":"GOBPID","id":48},{"name":"GO:0005575","longname":"cellular_component","pValue":1,"color":"#FFFFFF","type":"GOCCID","id":49},{"name":"GO:0005622","longname":"intracellular","pValue":0.0399,"color":"#FFFFFF","type":"GOCCID","id":50},{"name":"GO:0005623","longname":"cell","pValue":0.0727,"color":"#FFFFFF","type":"GOCCID","id":51},{"name":"GO:0005737","longname":"cytoplasm","pValue":0.0249,"color":"#FFFFFF","type":"GOCCID","id":52},{"name":"GO:0043226","longname":"organelle","pValue":0.0622,"color":"#FFFFFF","type":"GOCCID","id":53},{"name":"GO:0043227","longname":"membrane-bounded organelle","pValue":0.0622,"color":"#FFFFFF","type":"GOCCID","id":54},{"name":"GO:0043229","longname":"intracellular organelle","pValue":0.0622,"color":"#FFFFFF","type":"GOCCID","id":55},{"name":"GO:0043231","longname":"intracellular membrane-bounded organelle","pValue":0.0622,"color":"#FFFFFF","type":"GOCCID","id":56},{"name":"GO:0044424","longname":"intracellular part","pValue":0.0399,"color":"#FFFFFF","type":"GOCCID","id":57},{"name":"GO:0044444","longname":"cytoplasmic part","pValue":0.0659,"color":"#FFFFFF","type":"GOCCID","id":58},{"name":"GO:0044464","longname":"cell part","pValue":0.0727,"color":"#FFFFFF","type":"GOCCID","id":59}],"links":[{"source":"44","target":"45","value":1},{"source":"39","target":"32","value":1},{"source":"41","target":"39","value":1},{"source":"45","target":"32","value":1},{"source":"33","target":"38","value":1},{"source":"37","target":"39","value":1},{"source":"37","target":"45","value":1},{"source":"40","target":"37","value":1},{"source":"40","target":"41","value":1},{"source":"40","target":"44","value":1},{"source":"42","target":"44","value":1},{"source":"43","target":"37","value":1},{"source":"46","target":"33","value":1},{"source":"46","target":"47","value":1},{"source":"47","target":"38","value":1},{"source":"48","target":"40","value":1},{"source":"34","target":"35","value":1},{"source":"34","target":"36","value":1},{"source":"34","target":"46","value":1},{"source":"35","target":"42","value":1},{"source":"35","target":"43","value":1},{"source":"35","target":"48","value":1},{"source":"36","target":"42","value":1},{"source":"36","target":"47","value":1},{"source":"22","target":"34","value":1},{"source":"21","target":"34","value":1},{"source":"25","target":"34","value":1},{"source":"29","target":"38","value":1},{"source":"29","target":"33","value":1},{"source":"29","target":"46","value":1},{"source":"29","target":"47","value":1},{"source":"29","target":"34","value":1},{"source":"29","target":"36","value":1},{"source":"30","target":"34","value":1},{"source":"28","target":"34","value":1},{"source":"1","target":"44","value":1},{"source":"1","target":"40","value":1},{"source":"1","target":"42","value":1},{"source":"1","target":"43","value":1},{"source":"1","target":"48","value":1},{"source":"1","target":"34","value":1},{"source":"1","target":"35","value":1},{"source":"1","target":"36","value":1},{"source":"27","target":"44","value":1},{"source":"27","target":"32","value":1},{"source":"27","target":"38","value":1},{"source":"27","target":"39","value":1},{"source":"27","target":"41","value":1},{"source":"27","target":"45","value":1},{"source":"27","target":"33","value":1},{"source":"27","target":"37","value":1},{"source":"27","target":"40","value":1},{"source":"27","target":"42","value":1},{"source":"27","target":"43","value":1},{"source":"27","target":"46","value":1},{"source":"27","target":"47","value":1},{"source":"27","target":"48","value":1},{"source":"27","target":"34","value":1},{"source":"27","target":"35","value":1},{"source":"27","target":"36","value":1},{"source":"31","target":"44","value":1},{"source":"31","target":"40","value":1},{"source":"31","target":"42","value":1},{"source":"31","target":"43","value":1},{"source":"31","target":"48","value":1},{"source":"31","target":"34","value":1},{"source":"31","target":"35","value":1},{"source":"31","target":"36","value":1},{"source":"26","target":"46","value":1},{"source":"26","target":"47","value":1},{"source":"26","target":"34","value":1},{"source":"26","target":"36","value":1},{"source":"14","target":"34","value":1},{"source":"9","target":"34","value":1},{"source":"24","target":"42","value":1},{"source":"24","target":"34","value":1},{"source":"24","target":"35","value":1},{"source":"24","target":"36","value":1},{"source":"10","target":"44","value":1},{"source":"10","target":"40","value":1},{"source":"10","target":"42","value":1},{"source":"10","target":"48","value":1},{"source":"10","target":"34","value":1},{"source":"10","target":"35","value":1},{"source":"10","target":"36","value":1},{"source":"23","target":"44","value":1},{"source":"23","target":"32","value":1},{"source":"23","target":"39","value":1},{"source":"23","target":"41","value":1},{"source":"23","target":"45","value":1},{"source":"23","target":"37","value":1},{"source":"23","target":"40","value":1},{"source":"23","target":"42","value":1},{"source":"23","target":"43","value":1},{"source":"23","target":"48","value":1},{"source":"23","target":"34","value":1},{"source":"23","target":"35","value":1},{"source":"23","target":"36","value":1},{"source":"0","target":"44","value":1},{"source":"0","target":"32","value":1},{"source":"0","target":"39","value":1},{"source":"0","target":"41","value":1},{"source":"0","target":"45","value":1},{"source":"0","target":"37","value":1},{"source":"0","target":"40","value":1},{"source":"0","target":"42","value":1},{"source":"0","target":"43","value":1},{"source":"0","target":"48","value":1},{"source":"0","target":"34","value":1},{"source":"0","target":"35","value":1},{"source":"0","target":"36","value":1},{"source":"13","target":"38","value":1},{"source":"13","target":"33","value":1},{"source":"13","target":"46","value":1},{"source":"13","target":"47","value":1},{"source":"13","target":"34","value":1},{"source":"13","target":"36","value":1},{"source":"52","target":"58","value":1},{"source":"50","target":"57","value":1},{"source":"57","target":"52","value":1},{"source":"57","target":"55","value":1},{"source":"57","target":"58","value":1},{"source":"53","target":"54","value":1},{"source":"53","target":"55","value":1},{"source":"54","target":"56","value":1},{"source":"55","target":"56","value":1},{"source":"51","target":"59","value":1},{"source":"59","target":"50","value":1},{"source":"59","target":"57","value":1},{"source":"49","target":"51","value":1},{"source":"49","target":"53","value":1},{"source":"49","target":"59","value":1},{"source":"3","target":"49","value":1},{"source":"21","target":"49","value":1},{"source":"25","target":"52","value":1},{"source":"25","target":"50","value":1},{"source":"25","target":"57","value":1},{"source":"25","target":"53","value":1},{"source":"25","target":"54","value":1},{"source":"25","target":"55","value":1},{"source":"25","target":"56","value":1},{"source":"25","target":"58","value":1},{"source":"25","target":"51","value":1},{"source":"25","target":"59","value":1},{"source":"25","target":"49","value":1},{"source":"6","target":"49","value":1},{"source":"16","target":"49","value":1},{"source":"8","target":"49","value":1},{"source":"12","target":"49","value":1},{"source":"30","target":"49","value":1},{"source":"20","target":"52","value":1},{"source":"20","target":"50","value":1},{"source":"20","target":"57","value":1},{"source":"20","target":"53","value":1},{"source":"20","target":"54","value":1},{"source":"20","target":"55","value":1},{"source":"20","target":"56","value":1},{"source":"20","target":"58","value":1},{"source":"20","target":"51","value":1},{"source":"20","target":"59","value":1},{"source":"20","target":"49","value":1},{"source":"17","target":"49","value":1},{"source":"4","target":"49","value":1},{"source":"18","target":"49","value":1},{"source":"28","target":"52","value":1},{"source":"28","target":"50","value":1},{"source":"28","target":"57","value":1},{"source":"28","target":"51","value":1},{"source":"28","target":"59","value":1},{"source":"28","target":"49","value":1},{"source":"5","target":"49","value":1},{"source":"19","target":"49","value":1},{"source":"1","target":"50","value":1},{"source":"1","target":"57","value":1},{"source":"1","target":"53","value":1},{"source":"1","target":"54","value":1},{"source":"1","target":"55","value":1},{"source":"1","target":"56","value":1},{"source":"1","target":"51","value":1},{"source":"1","target":"59","value":1},{"source":"1","target":"49","value":1},{"source":"2","target":"49","value":1},{"source":"27","target":"52","value":1},{"source":"27","target":"50","value":1},{"source":"27","target":"57","value":1},{"source":"27","target":"53","value":1},{"source":"27","target":"54","value":1},{"source":"27","target":"55","value":1},{"source":"27","target":"56","value":1},{"source":"27","target":"58","value":1},{"source":"27","target":"51","value":1},{"source":"27","target":"59","value":1},{"source":"27","target":"49","value":1},{"source":"31","target":"50","value":1},{"source":"31","target":"57","value":1},{"source":"31","target":"53","value":1},{"source":"31","target":"54","value":1},{"source":"31","target":"55","value":1},{"source":"31","target":"56","value":1},{"source":"31","target":"51","value":1},{"source":"31","target":"59","value":1},{"source":"31","target":"49","value":1},{"source":"26","target":"52","value":1},{"source":"26","target":"50","value":1},{"source":"26","target":"57","value":1},{"source":"26","target":"53","value":1},{"source":"26","target":"54","value":1},{"source":"26","target":"55","value":1},{"source":"26","target":"56","value":1},{"source":"26","target":"51","value":1},{"source":"26","target":"59","value":1},{"source":"26","target":"49","value":1},{"source":"14","target":"49","value":1},{"source":"9","target":"49","value":1},{"source":"24","target":"52","value":1},{"source":"24","target":"50","value":1},{"source":"24","target":"57","value":1},{"source":"24","target":"53","value":1},{"source":"24","target":"54","value":1},{"source":"24","target":"55","value":1},{"source":"24","target":"56","value":1},{"source":"24","target":"51","value":1},{"source":"24","target":"59","value":1},{"source":"24","target":"49","value":1},{"source":"10","target":"52","value":1},{"source":"10","target":"50","value":1},{"source":"10","target":"57","value":1},{"source":"10","target":"53","value":1},{"source":"10","target":"54","value":1},{"source":"10","target":"55","value":1},{"source":"10","target":"56","value":1},{"source":"10","target":"58","value":1},{"source":"10","target":"51","value":1},{"source":"10","target":"59","value":1},{"source":"10","target":"49","value":1},{"source":"11","target":"50","value":1},{"source":"11","target":"57","value":1},{"source":"11","target":"53","value":1},{"source":"11","target":"54","value":1},{"source":"11","target":"55","value":1},{"source":"11","target":"56","value":1},{"source":"11","target":"51","value":1},{"source":"11","target":"59","value":1},{"source":"11","target":"49","value":1},{"source":"7","target":"49","value":1},{"source":"15","target":"49","value":1},{"source":"23","target":"52","value":1},{"source":"23","target":"50","value":1},{"source":"23","target":"57","value":1},{"source":"23","target":"53","value":1},{"source":"23","target":"54","value":1},{"source":"23","target":"55","value":1},{"source":"23","target":"56","value":1},{"source":"23","target":"58","value":1},{"source":"23","target":"51","value":1},{"source":"23","target":"59","value":1},{"source":"23","target":"49","value":1},{"source":"0","target":"52","value":1},{"source":"0","target":"50","value":1},{"source":"0","target":"57","value":1},{"source":"0","target":"58","value":1},{"source":"0","target":"51","value":1},{"source":"0","target":"59","value":1},{"source":"0","target":"49","value":1},{"source":"13","target":"52","value":1},{"source":"13","target":"50","value":1},{"source":"13","target":"57","value":1},{"source":"13","target":"53","value":1},{"source":"13","target":"54","value":1},{"source":"13","target":"55","value":1},{"source":"13","target":"56","value":1},{"source":"13","target":"58","value":1},{"source":"13","target":"51","value":1},{"source":"13","target":"59","value":1},{"source":"13","target":"49","value":1}]};
       graph.links.forEach(function(el) {
            delete el.value;
            el.source = parseInt(el.source);
            el.target = parseInt(el.target);
        });
        var str = JSON.stringify(graph);


        //Positioning genes on top and opening all
        var countGene = 0,
            countPValueAbove = 0,
            altAbove = 0;
        var level = 0,countNodesOnLevel=[];
        for (var i = 0; i < graph.nodes.length; i++) countNodesOnLevel[i] = 0;

        var link, node, node_drag, linkNodes = false;
      var div = d3.select("body").append("div")   
                .attr("class", "tooltip")               
                .style("opacity", 0);
        init();

        function init() {
            //Dísplay nodes on the positions
        graph.nodes.forEach(function(el) {
            if (el.type === "gene") {
                countGene++;
                el.x = 75 * countGene;
                el.y = 100;
                el.fixed = true;
                el.opened = true;
                var aux = [];
                displayTreeRecursively(el);
            } else {
                if (el.pValue > pValue) {
                    countPValueAbove++;
                    altAbove++;
                    if (altAbove === 4) altAbove = 0;
                    el.x = 300 + 30 * countPValueAbove;
                    el.y = 200 + 50 * altAbove;
                    el.fixed = true;
                    el.opened = false;
                }
            }
        });
            var force = self.force = d3.layout.force()
                .nodes(graph.nodes)
                .links(graph.links)
                .gravity(.05)
                .distance(100)
                .charge(-100)
                .size([w, h])
                .start();

            link = svg.selectAll("line.link")
                .data(graph.links)
                .enter().append("svg:line")
                .attr("class", "link")
                .attr("marker-end", "url(#arrowhead)")
                .attr("x1", function(d) {
                    return d.source.x;
                })
                .attr("y1", function(d) {
                    return d.source.y;
                })
                .attr("x2", function(d) {
                    return d.target.x;
                })
                .attr("y2", function(d) {
                    return d.target.y;
                });
            //color for lines
            /*.style("stroke",function(d){
                 n = graph.nodes.filter(function(el) {
                    return el.id === d.source.id;
                })[0];
                if (n.type.indexOf("gene") >= 0) return "#ffd900";
                else {
                    if (d.pValue <= 0.1) {
                        return "#2daec6";
                    } else
                        return "#50a161";
                } 

            });*/

            node_drag = d3.behavior.drag()
                .on("dragstart", dragstart)
                .on("drag", dragmove)
                .on("dragend", dragend);
          

            //Creating nodes with the data loaded from json. Ading click actions and tooltip
            node = svg.selectAll("g.node")
                .data(graph.nodes)
                .enter().append("svg:g")
                .attr("class", "node")
                .on("click", click)
                .call(node_drag)
                .on("mouseover", function(d) {
					d3.selectAll(".link").attr("class", "link");
					d3.selectAll(".link")
						.filter(function(l) {
							return (l.source === d) || (l.target === d);
						}).attr("class", "link selected");
  
                    div.transition()        
                        .duration(200)      
                        .style("opacity", .9);
                    var str = "<b>Name:</b> " + d.name +"<br/>"+
                    "<b>Longname:</b>" + d.longname + "<br/>"+
                    "<b>pValue:</b> " + d.pValue + "<br/>"+
                    "<b>Type: </b>"+d.type;  
					if(d.type == "gene"){
						str += "<br/><b>LogFC: </b>"+d.logFC; 
					}
                    div .html(str)  
                        .style("left", (d3.event.pageX) + "px")     
                        .style("top", (d3.event.pageY - 28) + "px");
                    })                  
                .on("mouseout", function(d) {    
					d3.selectAll(".link").attr("class", "link");				
                    div.transition()        
                        .duration(500)      
                        .style("opacity", 0);   
                });


            //Add a circle to the node and define its color
            node.filter(function(d){
                return d.type !== "gene";})
                .append("circle")
                .attr("r", 14)
                .style("cursor", "pointer")
                .style("fill", function(d, i) {     
                   if(d.type==="GOCCID"){
                        if(d.pValue>pValue) return "#ffd900";
                        else return "#fffe51"
                    }else if(d.type==="GOBPID"){
                        if(d.pValue>pValue) return "#c3a6c7";
                        else return "#de5cd7";
                    }else if(d.type==="GOMFID"){
                        if(d.pValue>pValue) return "#00c429";
                        else return "#00ff36";
                    }    
                });
			var dim = 32
            //Coloring Genes and adding rectangle
            node.filter(function(d){
                return d.type === "gene";})
                .append("rect")
                .attr("x", -dim)
                .attr("y", -dim)
                .attr("width",dim*2.5)
                .attr("height", dim)
                .style("cursor", "pointer")
                .style("fill", function(d, i) {
                    return d.color;
                });
            

            //Signal that indicate if the node it"s opened or not
            node.filter(function(d){
                return d.type !== "gene";})
                .append("svg:text")
                .attr("class", "openCircle")
                .attr("dx", -4)
                .attr("dy", 5)
                .style("font-weight", "bold")
                .style("font-size", "16")
                .style("cursor", "pointer")
                .text(function(d) {
                    if (d.opened) {
                        return "";
                    } else {
                        return "+";
                    }
                });

            //Adding longName and name to the nodes
            node.append("svg:text")
                .attr("class", "nodetext")
                .attr("dx", function(d) {
						if(d.type === "gene"){
							return -dim +5 
						}else{
							return 15 
						}                })
				.attr("dy", function(d) {
						if(d.type === "gene"){
							return -(dim/2)-2 
						}else{
							return 5 
						}                })
                .style("font-size", function(d) {
							if(d.type === "gene"){
								return 12
							}else{
								return 12
							}
				})
                .text(function(d) {
                    if(d.type === "gene"){
                        return d.name
                    }else{
                        return d.longname.substring(0,15) + "...";                       
                    }                });

            //Adding pValue into the nodes
            node.append("svg:text")
                .attr("class", "nodetext")
                .attr("dx", function(d) {
						if(d.type === "gene"){
							return -dim +5 
						}else{
							return 15 
						}                })
				.attr("dy", function(d) {
						if(d.type === "gene"){
							return -5 
						}else{
							return 18 
						}                })
                .style("font-size", "10")
                .text(function(d) {
                    return d.pValue
                });

            force.on("tick", tick);

            //Opening nodes, fixing nodes in the screen and positioning
            graph.nodes.forEach(function(el) {
                if (el.type === "gene") {
                    countGene++;
                    el.x = 150 * countGene;
                    el.y = 100;
                    el.fixed = true;
                    el.opened = true;
                } else {
                    if (el.pValue <= pValue) {
                        if (!el.x || !el.y) displayTreeRecursively(el);

                        el.fixed = true;
                        el.opened = true;
                    } else {
                        countPValueAbove++;
                        altAbove++;
                        if (altAbove === 4) altAbove = 0;
                        el.x = 100 + 30 * countPValueAbove;
                        el.y = 400 + 50 * altAbove;
                        el.fixed = true;
                        el.opened = false;
                    }
                }
            });

            updateNodesLinks();
        }

        function displayTreeRecursively(node) {
            var linksFromThatNode = [];
            //Search for the links that are source from the node clicked
            graph.links.forEach(function(link) {
                if (node.id === link.source) {
                    var n = graph.nodes.filter(function(n) {
                        return n.id === link.target;
                    })[0];
                    if (n && n.pValue <= pValue) {
                        link.target = n;
                        linksFromThatNode.push(link);
                    }
                }
            });

            //Sort the array utilizing it"s pValue
            linksFromThatNode.sort(function(a, b) {
                return (-1) * (a.target.pValue - b.target.pValue);
            });
            //Find the node that the link target to
            linksFromThatNode.forEach(function(link) {
                var n = graph.nodes.filter(function(n) {
                    return n.id === link.target.id;
                })[0];
                level++;
                    if (!n.x || !n.y) {
                        countNodesOnLevel[level]++;
                        n.x = 300+ 100*countNodesOnLevel[level];
                        n.y = 400+ 50*level;
                    }
                

                displayTreeRecursively(n);
                level--;
            });
        }

        function dragstart(d, i) {
            force.stop() // stops the force auto positioning before you start dragging
        }

        function dragmove(d, i) {
            d.px += d3.event.dx;
            d.py += d3.event.dy;
            d.x += d3.event.dx;
            d.y += d3.event.dy;
            tick(); // this is the key to make it work together with updating both px,py,x,y on d !
        }

        function dragend(d, i) {
            d.fixed = true; // of course set the node to fixed so the force doesn"t include the node in its auto positioning stuff
            tick();
            force.resume();
        }

        function tick() {
            link.attr("x1", function(d) {
                    return d.source.x;
                })
                .attr("y1", function(d) {
                    return d.source.y;
                })
                .attr("x2", function(d) {
                    return d.target.x;
                })
                .attr("y2", function(d) {
                    return d.target.y;
                });

            node.attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")";
            });
        }

        //Called when there is a click on node
        function click(d) {
            if (d3.event.defaultPrevented) return; // ignore drag
            updateNodesLinks(d);
        }

        function update(nodes, links) {

            // Update links.
            link = link.data(links);
            //link = link.data(links, function(d) { return d.source.id; });

            link.exit().remove();

            link.enter().insert("line", ".node")
                .attr("class", "link")
                .attr("marker-end", "url(#arrowhead)");

            // Update nodes.
            // IMPORTANT - Force node to mantain its index id
            node = node.data(nodes, function(d) {
                return d.id;
            });

            node.exit().remove();

            var nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .on("click", click)
                .call(node_drag)
                .on("mouseover", function(d) {
					d3.selectAll(".link").attr("class", "link");
					d3.selectAll(".link")
						.filter(function(l) {
							return (l.source === d) || (l.target === d);
						}).attr("class", "link selected");
						
                    div.transition()        
                        .duration(200)      
                        .style("opacity", .9);
                    var str = "<b>Name:</b> " + d.name +"<br/><b>Longname:</b>" + d.longname + "<br/><b>pValue:</b> " + d.pValue + "<br/><b>Type: </b>"+d.type;
                    div .html(str)  
                        .style("left", (d3.event.pageX) + "px")     
                        .style("top", (d3.event.pageY - 28) + "px");
                    })                  
                .on("mouseout", function(d) {  
					d3.selectAll(".link").attr("class", "link");				
                    div.transition()        
                        .duration(500)      
                        .style("opacity", 0);   
                });

          //Add a circle to the node and define its color
            nodeEnter.filter(function(d){
                return d.type !== "gene";})
                .append("circle")
                .attr("r", 14)
                .style("cursor", "pointer")
                .style("fill", function(d, i) {     
                   if(d.type==="GOCCID"){
                        if(d.pValue>pValue) return "#ffd900";
                        else return "#fffe51"
                    }else if(d.type==="GOBPID"){
                        if(d.pValue>pValue) return "#c3a6c7";
                        else return "#de5cd7";
                    }else if(d.type==="GOMFID"){
                        if(d.pValue>pValue) return "#00c429";
                        else return "#00ff36";
                    }    
                });
			var dim = 32;
            //Coloring Genes and adding rectangle
            nodeEnter.filter(function(d){
                return d.type === "gene";})
                .append("rect")
                .attr("x", -dim)
                .attr("y", -dim)
                .attr("width", dim*2.5)
                .attr("height", dim)
               .style("cursor", "pointer")
                .style("fill", function(d, i) {
                    return d.color;
                });
            

            //Signal that indicate if the node it"s opened or not
            nodeEnter.filter(function(d){
                return d.type !== "gene";})
                .append("svg:text")
                .attr("class", "openCircle")
                .attr("dx", -4)
                .attr("dy", 5)
                .style("font-size", "16")
                .style("font-weight", "bold")
                .style("cursor", "pointer")
                .text(function(d) {
                    if (d.opened) {
                        return "";
                    } else {
                        return "+";
                    }
                });
            nodeEnter.append("svg:text")
                .attr("class", "nodetext")
				.attr("dx", function(d) {
						if(d.type === "gene"){
							return -dim +5 
						}else{
							return 15 
						}                })
				.attr("dy", function(d) {
						if(d.type === "gene"){
							return -(dim/2)-2 
						}else{
							return 5 
						}                })
                .style("font-size", function(d) {
							if(d.type === "gene"){
								return 12
							}else{
								return 12
							}
				})
                .text(function(d) {
                    if(d.type === "gene"){
                        return d.name
                    }else{
                        return d.longname.substring(0,15) + "...";                       
                    }                });
            nodeEnter.append("svg:text")
                .attr("class", "nodetext")
				.attr("dx", function(d) {
						if(d.type === "gene"){
							return -dim +5 
						}else{
							return 15 
						}                })
				.attr("dy", function(d) {
						if(d.type === "gene"){
							return -5 
						}else{
							return 18 
						}                })
                .style("font-size", "10")
                .text(function(d) {
                    return d.pValue
                });


            //Remove all the signs to open node, to later add them only on the ones realy opened
            node.selectAll(".openCircle").remove();

            //Signal that indicate if the node it"s opened or not
            node.filter(function(d){
                return d.type !== "gene";})
                .append("svg:text")
                .attr("class", "openCircle")
                .attr("dx", -4)
                .attr("dy", 5)
                .style("cursor", "pointer")
                .style("font-weight", "bold")
                .style("font-size", "16")
                .text(function(d) {
                    if (d.opened) {
                        return "";
                    } else {
                        return "+";
                    }
                });
            //Color for line
            /*link.style("stroke",function(d){
                     n = nodes.filter(function(el) {
                        return el.id === d.source.id;
                    })[0];
                    if (n.type.indexOf("gene") >= 0) return "#ffd900";
                    else {
                        if (d.pValue <= 0.1) {
                            return "#2daec6";
                        } else
                            return "#50a161";
                    }
                })*/
            tick();
        }

        function updateNodesLinks(d) {
            var i, j;
            var node = [];
            var link = [];
            var linksForThatNode = [];

            //Defining if the node are suposed to open/close (toggle)
            if (d) {
                graph.nodes.forEach(function(el) {
                    if (d.name === el.name) {
                        if (el.opened) {
                            el.opened = 0;
                            closeAndOpenNodesRecursively(d, false);
                        } else {
                            el.opened = 1;
                            //closeAndOpenNodesRecursively(d,true);
                        }
                    }
                });
            }

            //Put links to a auxiliary array
            linksAux = [];
            graph.links.forEach(function(l) {
                linksAux.push(l);
            });
            linksToRemove = [];
            //Iterate through nodes to close one by one
            graph.nodes.forEach(function(n) {
                if (!n.opened) {
                    //Close node and return links to be removed from the link list
                    var linkFinal = removeNodesLinks(n);
                    linksToRemove = linksToRemove.concat(linkFinal);
                    //Remove links from list
                    linksToRemove.forEach(function(l) {
                        var index = linksAux.indexOf(l)
                        if (index >= 0) {
                            linksAux.splice(index, 1);
                        }
                    });
                }
            });

            //Final array with the links maintained
            link = link.concat(linksAux);


            //Managing the nodes that are suposed to be Added according to the links
            graph.nodes.forEach(function(n) {

                //If it isn"t gene, verify if it"s a node without links - Don"t close gene nodes
               //if (n.type !== "gene") {
                    if (n.pValue > pValue || n.type === "gene") {
                        var addIt = false;
                        link.forEach(function(l) {

                            if (n.id === l.source.id) {
                                addIt = true;
                            }
                        });
                        if (addIt) {
                            node.push(n);
                        }
                    } else {
                        node.push(n);
                    }
                //} else {
                 //   node.push(n);
                //}

            });

			//Add links between genes and closed nodes that is visible. 
			var linksNodesToGenes = [];
			var linksNodesToGenesFound = []
			node.forEach(function(n) {
				linksNodesToGenes = graph.links.filter(function(l) {
					if(n.name == l.target.name && l.target.type == "GOBPID" && l.source.type == "gene" ){
						return true;
					}
					return false;
				});
				linksNodesToGenes.forEach(function(link1) {
					var found = false;
					link.forEach(function(link2) {
						if(link1.source.name == link2.source.name && link1.target.name == link2.target.name){
							found = true;
						}
					});
					if(!found){
						linksNodesToGenesFound.push(link1);
					}
				});
            });
			//Add just links that have a visible nodes 
			for(var x = linksNodesToGenesFound.length-1; x >= 0;x--){
				for(t = 0; t < node.length;t++){
					if(node[t].name === linksNodesToGenesFound[x].source.name){
						link.push(linksNodesToGenesFound[x]);
						break;
					}
				}
			}
			
			
			
            //Update nodes and links in the d3 lib
            update(node, link);
			d3.selectAll(".link").attr("class", "link");	
        }

        function closeAndOpenNodesRecursively(node, open) {
            var linksFromThatNode = [];
            //Search for the links that target to the node clicked
            linksFromThatNode = graph.links.filter(function(link) {
				if(node.name === link.target.name){
					return true;
				}
				return false;
            });
            //Sort the array utilizing it"s pValue
            linksFromThatNode.sort(function(a, b) {
                return (a.target.pValue - b.target.pValue);
            });
            //Find the node that the link is source from
            linksFromThatNode.forEach(function(link) {
                var n = graph.nodes.filter(function(n) {
                    return n.id === link.source.id;
                })[0];
                n.opened = open;
                closeAndOpenNodesRecursively(n, open);
            });
        }

        function removeNodesLinks(node) {
            var linksTOThatNode = [];
            //Search for the links that are target from the node clicked. If the connection is between genes and nodes above pValue, the connection can be removed
            linksTOThatNode = linksAux.filter(function(link) {
                return (node.name === link.target.name && link.source.type !== "gene") || (node.name === link.target.name && node.pValue > pValue);
            });
            //Sort the array utilizing it"s pValue
            linksTOThatNode.sort(function(a, b) {
                return (a.source.pValue - b.source.pValue);
            });
            //Find the node that the link target to
            linksTOThatNode.forEach(function(linkToN) {
                var n = graph.nodes.filter(function(n) {
                    return n.id === linkToN.source.id;
                })[0];
                //Verify if there is connection source from this node
                if (!verifyConnection(node, n)) {
                    var removeIt = false;
                    //Verify if that node has links to be removed
                    linksAux.forEach(function(l) {
                        //Verify if there"s a source from that node
                        if (n.id === l.source.id) {
                            removeIt = true;
                        }
                    });
                    if (removeIt) {
                        //Navigate to the target node recursively to search for more links to be removed
                        linksToRemove = linksToRemove.concat(removeNodesLinks(n));
                    }
                }

            });

            return linksTOThatNode;
        }

        function verifyConnection(nodeSource, nodeVerified) {
            var connected = false;
            var arrayAux = [];
            arrayAux = arrayAux.concat(graph.links);
            //Remove links from the original list to get an updated list
            linksToRemove.forEach(function(l) {
                var index = arrayAux.indexOf(l)
                if (index >= 0) {
                    arrayAux.splice(index, 1);
                }
            });
            arrayAux.forEach(function(l) {
                //Verify if there"s a target to that node differente from the source
                if (nodeVerified.id === l.source.id) {
                    connected = true;
                }
            });
            return connected;
        }

        function linkUnlink() {
            linkNodes = !linkNodes;
            if (linkNodes) {
                graph.nodes.forEach(function(el) {
                    el.opened = true;
                });
            } else {
                graph.nodes.forEach(function(el) {
                    el.opened = false;
                });

            }
            updateNodesLinks();
        }

        function setPValue(){
            var aux= parseFloat(document.getElementById("pValue").value);
            pValue = aux;
            level = 0,countNodesOnLevel=[];
        for (var i = 0; i < graph.nodes.length; i++) countNodesOnLevel[i] = 0;
            node = svg.selectAll("g.node").remove();
            link = svg.selectAll("line.link").remove();

            init();
        }
    </script>
</body>

</html>
